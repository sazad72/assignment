<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Assignment Marker</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- SheetJS library for Excel processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .logo {
      font-size: 2.8rem;
      color: #4a6fa5;
      margin-bottom: 10px;
    }

    h1 {
      color: #2c3e50;
      font-size: 2.2rem;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #7f8c8d;
      font-size: 1.1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .app-container {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      margin-bottom: 30px;
    }

    .upload-section {
      flex: 1;
      min-width: 300px;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .feedback-section {
      flex: 2;
      min-width: 300px;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      display: none;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 1.4rem;
    }

    .section-title i {
      color: #4a6fa5;
    }

    .upload-area {
      border: 2px dashed #bdc3c7;
      border-radius: 10px;
      padding: 30px 20px;
      text-align: center;
      margin-bottom: 25px;
      transition: all 0.3s;
      background: #f8f9fa;
    }

    .upload-area:hover {
      border-color: #4a6fa5;
      background: #f0f4f8;
    }

    .upload-area i {
      font-size: 3rem;
      color: #7f8c8d;
      margin-bottom: 15px;
    }

    .file-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
    }

    .file-input:focus {
      outline: none;
      border-color: #4a6fa5;
      box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
    }

    .file-info {
      background: #e8f4fc;
      padding: 10px 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 0.9rem;
      display: none;
    }

    .btn {
      background: linear-gradient(to right, #4a6fa5, #6b93d6);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      transition: all 0.3s;
      margin-top: 20px;
    }

    .btn:hover {
      background: linear-gradient(to right, #3a5a8c, #5a83c6);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(74, 111, 165, 0.3);
    }

    .btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .progress-container {
      margin-top: 25px;
      display: none;
    }

    .progress-bar {
      height: 10px;
      background: #ecf0f1;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(to right, #2ecc71, #1abc9c);
      width: 0%;
      border-radius: 5px;
      transition: width 0.5s ease;
    }

    .progress-text {
      text-align: center;
      font-size: 0.9rem;
      color: #7f8c8d;
    }

    .feedback-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-top: 20px;
    }

    .feedback-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    .feedback-table th {
      background: #4a6fa5;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .feedback-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    .feedback-table tr:nth-child(even) {
      background: #f8f9fa;
    }

    .feedback-table tr:hover {
      background: #e8f4fc;
    }

    .score-cell {
      font-weight: 700;
      color: #2c3e50;
    }

    .total-score {
      background: #2c3e50;
      color: white;
      font-weight: 700;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-top: 20px;
      font-size: 1.2rem;
    }

    .download-section {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    .download-btn {
      flex: 1;
      background: linear-gradient(to right, #27ae60, #2ecc71);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s;
      text-decoration: none;
    }

    .download-btn:hover {
      background: linear-gradient(to right, #219653, #27ae60);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }

    .download-btn.secondary {
      background: linear-gradient(to right, #7f8c8d, #95a5a6);
    }

    .download-btn.secondary:hover {
      background: linear-gradient(to right, #6c7b7d, #7f8c8d);
    }

    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
      font-weight: 600;
      display: none;
    }

    .success {
      background: #d5f4e6;
      color: #27ae60;
      border: 1px solid #a3e4c1;
    }

    .error {
      background: #fdecea;
      color: #e74c3c;
      border: 1px solid #f5b7b1;
    }

    .empty-state {
      text-align: center;
      color: #95a5a6;
      padding: 40px 20px;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .summary-stats {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-card {
      flex: 1;
      min-width: 150px;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      border-left: 4px solid #4a6fa5;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #7f8c8d;
    }

    .excel-preview {
      font-size: 0.85rem;
      color: #666;
      margin-top: 10px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 5px;
      display: none;
    }

    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      
      .download-section {
        flex-direction: column;
      }
      
      .summary-stats {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <i class="fas fa-robot"></i>
      </div>
      <h1>AI Assignment Marker</h1>
      <p class="subtitle">Upload your rubric and assignment to receive detailed AI-powered feedback with scores for each criterion.</p>
    </header>

    <div class="app-container">
      <div class="upload-section">
        <div class="section-title">
          <i class="fas fa-upload"></i>
          <h2>Upload Files</h2>
        </div>
        
        <div class="upload-area">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Drag and drop files here or click to browse</p>
          <p class="file-info" id="fileInfo"></p>
        </div>

        <form id="markForm" enctype="multipart/form-data">
          <label for="rubricFile"><strong>Rubric File (Excel)</strong></label>
          <input type="file" id="rubricFile" name="rubric" class="file-input" accept=".xlsx,.xls" required />
          <small>Excel file containing marking criteria and scoring guidelines.</small>
          
          <div style="height: 20px;"></div>
          
          <label for="assignmentFile"><strong>Assignment File</strong></label>
          <input type="file" id="assignmentFile" name="assignment" class="file-input" accept=".txt,.pdf,.docx,.doc" required />
          <small>Accepted formats: TXT, PDF, DOCX, DOC</small>
          
          <button type="submit" class="btn" id="markBtn">
            <i class="fas fa-marker"></i>
            Mark Assignment
          </button>
        </form>

        <div class="progress-container" id="progressContainer">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">Preparing to mark assignment...</div>
        </div>

        <div class="status-message" id="statusMessage"></div>
      </div>

      <div class="feedback-section" id="feedbackSection">
        <div class="section-title">
          <i class="fas fa-chart-bar"></i>
          <h2>Feedback & Scores</h2>
        </div>
        
        <div class="summary-stats" id="summaryStats" style="display: none;">
          <div class="stat-card">
            <div class="stat-value" id="totalScoreValue">0</div>
            <div class="stat-label">Total Score</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="maxScoreValue">0</div>
            <div class="stat-label">Total Allocated</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="percentageValue">0%</div>
            <div class="stat-label">Percentage</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="criteriaCount">0</div>
            <div class="stat-label">Criteria</div>
          </div>
        </div>
        
        <div id="feedbackContent">
          <div class="empty-state" id="emptyState">
            <i class="fas fa-clipboard-list"></i>
            <p>Upload and mark an assignment to see detailed feedback here.</p>
          </div>
          
          <div class="feedback-container" id="feedbackContainer" style="display: none;">
            <table class="feedback-table" id="feedbackTable">
              <thead id="feedbackTableHeader">
                <!-- Will be populated dynamically from Excel -->
              </thead>
              <tbody id="feedbackTableBody">
                <!-- Will be populated dynamically from Excel -->
              </tbody>
            </table>
          </div>
          
          <div class="excel-preview" id="excelPreview">
            <i class="fas fa-info-circle"></i>
            <span>Data loaded from Excel file. Click "Download Excel" to get the full file.</span>
          </div>
          
          <div class="download-section">
            <button class="download-btn" id="downloadDetailedBtn" style="display: none;">
              <i class="fas fa-download"></i>
              Download Detailed Report
            </button>
            <button class="download-btn secondary" id="downloadExcelBtn" style="display: none;">
              <i class="fas fa-file-excel"></i>
              Download Excel File
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <footer style="text-align: center; color: #7f8c8d; margin-top: 30px; padding: 20px;">
      <p>AI Assignment Marker v2.0 ‚Ä¢ Powered by GenAI ‚Ä¢ Process assignments with detailed rubric-based evaluation</p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const markForm = document.getElementById('markForm');
      const markBtn = document.getElementById('markBtn');
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const statusMessage = document.getElementById('statusMessage');
      const feedbackSection = document.getElementById('feedbackSection');
      const feedbackContainer = document.getElementById('feedbackContainer');
      const feedbackTableHeader = document.getElementById('feedbackTableHeader');
      const feedbackTableBody = document.getElementById('feedbackTableBody');
      const emptyState = document.getElementById('emptyState');
      const downloadDetailedBtn = document.getElementById('downloadDetailedBtn');
      const downloadExcelBtn = document.getElementById('downloadExcelBtn');
      const fileInfo = document.getElementById('fileInfo');
      const rubricFile = document.getElementById('rubricFile');
      const assignmentFile = document.getElementById('assignmentFile');
      const summaryStats = document.getElementById('summaryStats');
      const excelPreview = document.getElementById('excelPreview');
      const totalScoreValue = document.getElementById('totalScoreValue');
      const maxScoreValue = document.getElementById('maxScoreValue');
      const percentageValue = document.getElementById('percentageValue');
      const criteriaCount = document.getElementById('criteriaCount');
      
      // Variables to store the Excel data
      let excelData = null;
      let excelBlob = null;
      
      // Update file info display
      function updateFileInfo() {
        const rubricFileName = rubricFile.files[0]?.name || 'No file selected';
        const assignmentFileName = assignmentFile.files[0]?.name || 'No file selected';
        
        fileInfo.textContent = `Rubric: ${rubricFileName} | Assignment: ${assignmentFileName}`;
        fileInfo.style.display = 'block';
      }
      
      rubricFile.addEventListener('change', updateFileInfo);
      assignmentFile.addEventListener('change', updateFileInfo);
      
      // Handle form submission
      markForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Disable the button and show progress
        markBtn.disabled = true;
        markBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Marking Assignment...';
        progressContainer.style.display = 'block';
        statusMessage.style.display = 'none';
        
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress > 90) progress = 90;
          progressFill.style.width = `${progress}%`;
          
          if (progress < 30) {
            progressText.textContent = "Analyzing rubric structure...";
          } else if (progress < 60) {
            progressText.textContent = "Reading and evaluating assignment...";
          } else {
            progressText.textContent = "Generating detailed feedback...";
          }
        }, 400);
        
        try {
          // Real implementation - send files to backend
          const formData = new FormData(markForm);
          
          const response = await fetch("https://marking-41ml.onrender.com/mark", {
            method: "POST",
            body: formData
          });
          
          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }
          
          // Get the Excel file from response
          excelBlob = await response.blob();
          
          // Clear the progress simulation
          clearInterval(progressInterval);
          progressFill.style.width = '100%';
          progressText.textContent = "Processing Excel file...";
          
          // Process the Excel file
          await processExcelFile(excelBlob);
          
          // Show success message
          statusMessage.textContent = "‚úÖ Assignment marked successfully!";
          statusMessage.className = "status-message success";
          statusMessage.style.display = 'block';
          
          // Reset button
          markBtn.disabled = false;
          markBtn.innerHTML = '<i class="fas fa-marker"></i> Mark Assignment';
          
          // Show feedback section
          feedbackSection.style.display = 'block';
          
          // Enable download buttons
          downloadDetailedBtn.style.display = 'flex';
          downloadExcelBtn.style.display = 'flex';
          
          // Scroll to feedback section
          feedbackSection.scrollIntoView({ behavior: 'smooth' });
          
        } catch (error) {
          clearInterval(progressInterval);
          
          // Show error message
          statusMessage.textContent = `‚ùå Error marking assignment: ${error.message}`;
          statusMessage.className = "status-message error";
          statusMessage.style.display = 'block';
          
          // Reset button
          markBtn.disabled = false;
          markBtn.innerHTML = '<i class="fas fa-marker"></i> Mark Assignment';
          
          console.error('Error:', error);
        }
      });
      
      // Process Excel file using SheetJS
      async function processExcelFile(blob) {
        try {
          // Convert blob to ArrayBuffer
          const arrayBuffer = await blob.arrayBuffer();
          
          // Parse Excel file
          const workbook = XLSX.read(arrayBuffer, { type: 'array' });
          
          // Get the first worksheet
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          
          // Convert to JSON
          const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          // Store the data
          excelData = data;
          
          // Display the data in table
          displayExcelData(data);
          
        } catch (error) {
          console.error('Error processing Excel file:', error);
          throw new Error('Failed to process Excel file');
        }
      }
      
      // Display Excel data in table
      function displayExcelData(data) {
        if (!data || data.length === 0) {
          statusMessage.textContent = "‚ùå No data found in Excel file";
          statusMessage.className = "status-message error";
          statusMessage.style.display = 'block';
          return;
        }
        
        // Hide empty state
        emptyState.style.display = 'none';
        
        // Clear existing table
        feedbackTableHeader.innerHTML = '';
        feedbackTableBody.innerHTML = '';
        
        // Assume first row is header
        const headers = data[0];
        
        // Create table header
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header || 'Column';
          headerRow.appendChild(th);
        });
        feedbackTableHeader.appendChild(headerRow);
        
        // Create table rows from data (skip header row)
        let totalScore = 0;
        let maxScore = 0;
        let scoreColumnIndex = -1;
        let maxScoreColumnIndex = -1;
        
        // Try to find score and max score columns
        headers.forEach((header, index) => {
          if (header && typeof header === 'string') {
            const headerLower = header.toLowerCase();
            if (headerLower.includes('student_mark') && !headerLower.includes('max')) {
              scoreColumnIndex = index;
            }
            if (headerLower.includes('max_mark') || headerLower.includes('total')) {
              maxScoreColumnIndex = index;
            }
          }
        });
        
        for (let i = 1; i < data.length; i++) {
          const rowData = data[i];
          if (!rowData || rowData.length === 0) continue;
          
          const row = document.createElement('tr');
          
          rowData.forEach((cell, index) => {
            const td = document.createElement('td');
            
            // Apply special formatting for score columns
            if (index === scoreColumnIndex || index === maxScoreColumnIndex) {
              td.className = 'score-cell';
              
              // Try to parse numeric values
              const numericValue = parseFloat(cell);
              if (!isNaN(numericValue)) {
                // Add to totals if it's a score
                if (index === scoreColumnIndex) {
                  totalScore += numericValue;
                }
                if (index === maxScoreColumnIndex) {
                  maxScore += numericValue;
                }
              }
            }
            
            td.textContent = cell !== undefined && cell !== null ? cell : '';
            row.appendChild(td);
          });
          
          feedbackTableBody.appendChild(row);
        }
        
        // Show the table container
        feedbackContainer.style.display = 'block';
        excelPreview.style.display = 'block';
        
        // Update summary statistics
        updateSummaryStats(totalScore, maxScore, data.length - 1);
      }
      
      // Update summary statistics
      function updateSummaryStats(total, max, criteria) {
        summaryStats.style.display = 'flex';
        
        totalScoreValue.textContent = total.toString();
        maxScoreValue.textContent = max.toString();
        
        const percentage = max > 0 ? (total / max) * 100 : 0;
        percentageValue.textContent = `${percentage.toFixed(2)}%`;
        
        criteriaCount.textContent = criteria;
      }
      
      // Handle download detailed report
      downloadDetailedBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (!excelData) {
          statusMessage.textContent = "‚ùå No data available to download";
          statusMessage.className = "status-message error";
          statusMessage.style.display = 'block';
          return;
        }
        
        // Convert Excel data to text format
        let reportText = "AI ASSIGNMENT MARKER - DETAILED FEEDBACK REPORT\n";
        reportText += "=================================================\n\n";
        reportText += `Generated: ${new Date().toLocaleString()}\n\n`;
        
        // Add data from Excel
        excelData.forEach((row, rowIndex) => {
          reportText += row.map(cell => {
            // Handle undefined/null cells
            if (cell === undefined || cell === null) return '';
            return String(cell);
          }).join('\t') + '\n';
          
          // Add separator after header
          if (rowIndex === 0) {
            reportText += "-------------------------------------------------\n";
          }
        });
        
        reportText += "\n=================================================\n";
        reportText += "End of Report";
        
        // Create and download text file
        const blob = new Blob([reportText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `assignment_feedback_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // Show download confirmation
        statusMessage.textContent = "üì• Detailed report downloaded!";
        statusMessage.className = "status-message success";
        statusMessage.style.display = 'block';
      });
      
      // Handle download Excel file
      downloadExcelBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (!excelBlob) {
          statusMessage.textContent = "‚ùå No Excel file available to download";
          statusMessage.className = "status-message error";
          statusMessage.style.display = 'block';
          return;
        }
        
        // Download the original Excel file
        const url = window.URL.createObjectURL(excelBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `marked_assignment_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // Show download confirmation
        statusMessage.textContent = "üì• Excel file downloaded!";
        statusMessage.className = "status-message success";
        statusMessage.style.display = 'block';
      });
      
      // Drag and drop functionality
      const uploadArea = document.querySelector('.upload-area');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        uploadArea.style.borderColor = '#4a6fa5';
        uploadArea.style.backgroundColor = '#f0f4f8';
      }
      
      function unhighlight() {
        uploadArea.style.borderColor = '#bdc3c7';
        uploadArea.style.backgroundColor = '#f8f9fa';
      }
      
      uploadArea.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const rubricFiles = dt.files;
        
        if (rubricFiles.length > 0) {
          // For simplicity, we'll just update the first file input
          // In a full implementation, you'd handle both file inputs
          updateFileInfo();
        }
      }
    });
  </script>
</body>
</html>
